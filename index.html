<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./ScrollMagic.js"></script>
    <script src="./noframework.waypoints.min.js"></script>
    <script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v3.min.js"></script>
  </head>
  <body>

    <style>

      .intro {
        height: 100vh;
        width: 100%;
      }

      .box2 {
        height: 400px;
        width: 100%;
      }
      /* .scrollmagic-pin-spacer {
        height: 50px !important;
      } */

      .pin-container {
        display: flex;
        flex-direction: row;
      }
      #map{
        width: 60%;
        height: 100vh;


      }
      #pin2 {
        width: 40%;
        height: 5000px;

      }
      .first {
        height: 100vh;
        background-color: green;
      }

      .second {
        height: 100vh;
        background-color: yellow;
      }

      .third {
        height: 100vh;
        background-color: orange;
      }
      .fourth {
        height: 100vh;
        background-color: blue;
      }
      .fifth {
        height: 100vh;
        background-color: black;
      }
      .sixth {
        height: 100vh;
        background-color: green;
      }

    </style>

    <div class="scrollContent">
				<section id="titlechart">
          <div class="intro">
            <p>welcome to Europe</p>
					</div>
					<script>
						// init controller
						var controller = new ScrollMagic.Controller();
					</script>
				</section>
				<section class="demo">
					<div class="spacer s2"></div>
          <div class="trigger-container">
            <div id="trigger-map"></div>
            <div id="trigger-explanation"></div>
            <div id="trigger-first-section"></div>
          </div>
          <div class="pin-container">
  					<div id="map"></div>
  					<div id="pin2">
              <div class="first section"></div>
              <div id="reverse-enter-section-1"></div>
              <div id="enter-section-2"></div>
              <div id="pin3" class="second section"></div>
              <div id="reverse-enter-section-2"></div>
              <div id="enter-section-3"></div>
              <div id='pin4' class="third section"></div>
              <div id="reverse-enter-section-3"></div>
              <div id="enter-seciton-4"></div>
              <div id="reverse-enter-section-4"></div>
              <div id='pin5' class="fourth section"></div>
              <div id="enter-section-5"></div>
              <div id="reverse-enter-section-5"></div>
              <div id='pin6' class="fifth section"></div>
              <div id="enter-section-6"></div>
              <div id="reverse-enter-section-6"></div>
              <div id='pin7' class="sixth section"></div>
  					</div>
          </div>
					<div class="spacer s2"></div>
					<script>
						$(function () { // wait for document ready
							// build scene
							var scene1 = new ScrollMagic.Scene({triggerElement: "#trigger-map",triggerHook: 0, duration: 10810})
											.setPin("#map")
											// .addIndicators({name: "1 (duration: 300)"}) // add indicators (requires plugin)
											.addTo(controller);

							var scene2 = new ScrollMagic.Scene({triggerElement: "#trigger-explanation",triggerHook: 0, duration: 600})
											.setPin("#pin2")
											// .addIndicators({name: "2 (duration: 500)"}) // add indicators (requires plugin)
											.addTo(controller);

							var scene3 = new ScrollMagic.Scene({triggerElement: "#enter-section-2",triggerHook: 0, duration: 600})
											.setPin("#pin3")
											// .addIndicators({name: "2 (duration: 500)"}) // add indicators (requires plugin)
											.addTo(controller);

							var scene4 = new ScrollMagic.Scene({triggerElement: "#enter-section-3",triggerHook: 0, duration: 600})
											.setPin("#pin4")
											// .addIndicators({name: "2 (duration: 500)"}) // add indicators (requires plugin)
											.addTo(controller);
							var scene5 = new ScrollMagic.Scene({triggerElement: "#enter-seciton-4",triggerHook: 0, duration: 600})
											.setPin("#pin5")
											// .addIndicators({name: "2 (duration: 500)"}) // add indicators (requires plugin)
											.addTo(controller);
							var scene6 = new ScrollMagic.Scene({triggerElement: "#enter-section-5",triggerHook: 0, duration: 600})
											.setPin("#pin6")
											// .addIndicators({name: "2 (duration: 500)"}) // add indicators (requires plugin)
											.addTo(controller);
							var scene7 = new ScrollMagic.Scene({triggerElement: "#enter-section-6",triggerHook: 0, duration: 600})
											.setPin("#pin7")
											// .addIndicators({name: "2 (duration: 500)"}) // add indicators (requires plugin)
											.addTo(controller);

						});
					</script>
				</section>


			</div>
      <script>
      const height = 900;
      const width = 1200;
      // geoOrthographic
      // var projection = d3.geoMercator()
      //               .center([ 15, 60 ])
      // 					   .translate([ width/2, height/2 ])
      // 					   .scale([ width/2.3 ]);

      const projection = d3.geoOrthographic()
                        .center([ 20, 28 ])
                        .translate([ width/2, height/2 ])
                        .scale([ width/1.2 ])
                        .rotate([-10, -20, -10 ]);


      let europe = void 0;

      const path = d3.geoPath().projection(projection);

      const svg = d3.select('#map')
                    .append('svg')
                    .attr('height', height)
                    .attr('width', width)


      const membership = {};

      d3.csv("EuropeanStates.csv", function(data) {

        for (var i = 0; i < data.length; i++) {
          membership[data[i].State] = data[i]
        }
          console.log(membership);
      });





      const colorScheme = {
        'EU': {
          'EU': 'blue',
          'Candidate': 'red'
        },
        'Currency': {
          'â‚¬': 'blue',
          'DKK': 'orange',
          'SEK': 'orange',
          'GBP': 'orange',
        },
        'Euro-relation': {
          'yes': 'blue',
          'obligated': '#87CEFA',
          'exempt': 'orange'
        },
        'NATO': {
          'NATO': 'blue'
        },
        'CurrencyUnion': {
          'EUCU': 'blue'
        },
        'Schengen': {
          'Schengen': 'blue',
          'visa-free': 'red'
        },
        'EEA': {
          'EEA': 'blue'
        }

      }

      const colorify = (data, cat) => {


        let stateName = data.properties.admin
        if (!membership[stateName]) { return 'gray' }

        let status = membership[stateName][`${cat}`]
        if (!colorScheme[`${cat}`][`${status}`]) { return 'gray' }
        return colorScheme[`${cat}`][`${status}`]

      }



      const handleUpdate = (category) => {

        d3.selectAll('path')
            .attr('fill', (d) => colorify(d, category))
      }

      const adjustIncome = (realIncome) => {

        if (realIncome > 50000) { realIncome = 50000 }
        return realIncome
      }

      const handleIncome = () => {

        const colorbyIncome = d3.scaleLinear().domain([100, 50000]).range(['yellow', 'red']);

        d3.selectAll('path')
            .attr('fill', (d) => {
              let stateName = d.properties.admin
              if (!membership[stateName]) { return 'yellow' }
              let status = membership[stateName]['GNI']
              // console.log(parseInt(status.split(',').join('')));
              let number = parseInt(status.split(',').join(''))
              let adjusted = adjustIncome(number)
              return colorbyIncome(adjusted)

            })


      }

      d3.json("region_un_Europe_subunits.json", function(error, data) {

         const countries = data.features

         map = svg.append('g').attr('class', 'boundary');

         europe = map.selectAll('path').data(countries) //must always be features regardless of what it says in json

         // let organization = 'EU'
         // let membershipStatus = 'EU'

        europe.enter()
          .append('path')
          .attr('d', path)
          .attr('stroke', '#555')
          .attr('fill', (d) => colorify(d, 'EU'))
          // .on('click', (d) => console.log(d.properties.admin))



        europe.exit().remove();


      })


      const ranges = {};
      let windowHeight = window.innerHeight
      const sections = document.querySelectorAll('.section')
      for (var i = 0; i < sections.length; i++) {
        let top = sections[i].offsetTop + windowHeight

        ranges[top] = i + 1;
      }



      const enter1 = new Waypoint({
        element: document.getElementById('trigger-first-section'),
        handler: function() {
          console.log('entered 1st');
          handleUpdate('EU')
        }
      })
      const reverseEnter1 = new Waypoint({
        element: document.getElementById('reverse-enter-section-1'),
        handler: function() {
          console.log('enter reverse 1st');
          handleUpdate('EU')
        },
        offset: '50%'
      })

      const enter2 = new Waypoint({
        element: document.getElementById('enter-section-2'),
        handler: function() {
          console.log('this is the Currency waypoint');
          handleUpdate('Euro-relation')
        }
      })
      const reverseEnter2 = new Waypoint({
        element: document.getElementById('reverse-enter-section-2'),
        handler: function() {
          console.log('this is the Currency waypoint');
          handleUpdate('Euro-relation')
        },
        offset: '50%'
      })

      const enter3 = new Waypoint({
        element: document.getElementById('enter-section-3'),
        handler: function() {
          console.log('this is the Schengen waypoint');
          handleUpdate('Schengen')
        }
      })

      const reverseEnter3 = new Waypoint({
        element: document.getElementById('reverse-enter-section-3'),
        handler: function() {
          console.log('this is the Schengen waypoint');
          handleUpdate('Schengen')
        },
        offset: '50%'
      })

      const enter4 = new Waypoint({
        element: document.getElementById('enter-seciton-4'),
        handler: function() {
          console.log('this is the EEA waypoint');
          handleUpdate('EEA')
        }
      })
      const reverseEnter4 = new Waypoint({
        element: document.getElementById('reverse-enter-section-4'),
        handler: function() {
          console.log('this is the EEA waypoint');
          handleUpdate('EEA')
        },
        offset: '50%'
      })


      const enter5 = new Waypoint({
        element: document.getElementById('enter-section-5'),
        handler: function() {
          console.log('this is the CurrencyUnion waypoint');
          handleUpdate('CurrencyUnion')
        }
      })
      const reverseEnter5 = new Waypoint({
        element: document.getElementById('reverse-enter-section-5'),
        handler: function() {
          console.log('this is the CurrencyUnion waypoint');
          handleUpdate('CurrencyUnion')
        },
        offset: '50%'
      })

      const enter6 = new Waypoint({
        element: document.getElementById('enter-section-6'),
        handler: function() {
          console.log('this is the income waypoint');
          handleIncome()
        }
      })
      const reverseEnter6 = new Waypoint({
        element: document.getElementById('reverse-enter-section-6'),
        handler: function() {
          console.log('this is the income waypoint');
          handleIncome()
        },
        offset: '50%'
      })


    </script>
  </body>
</html>
